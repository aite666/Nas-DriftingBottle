<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>星云漂流瓶</title>

    <style>

    </style>
</head>
<body>
<div class="row" style="background: url(lib/img/bg.png) no-repeat; background-size: 100% 100%;min-height:900px;">
    <div class="col offset-s2 s8">
        <div>
            <h4 style="text-align: center;">步骤说明</h4>
            <p style="font-size: 20px;">1.登录自己的钱包查看余额</p>
            <p style="font-size: 20px;">2.余额大于0.5nas的地址可以扔出一个漂流瓶</p>
            <p style="font-size: 20px;">3.余额大于0.1nas的地址可以捞起一个漂流瓶</p>
            <p style="font-size: 20px;">4.应用推广阶段,仅需支付 gas 即可参与</p>
        </div>

        <div class="col s6">
            <p style="font-size: 20px;">导入钱包文件</p>
            <div class="file-field input-field ">
                <button class="btn waves-effect waves-light red">
                    <span>点击选择您的密钥文件</span>
                    <input type="file" id="keyfile">
                </button>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text">
                </div>
            </div>
        </div>
        <div class="offset-s1 col s5">
            <div id="keyfilepassworddiv" style="display: none;margin-top: 40px;">
                <label for="keyfilepassword" class="active" style="font-size: 20px;color: #000;">请输入您的密钥文件密码</label>
                <input placeholder="请输入您的密钥文件密码" class="center-align" id="keyfilepassword" type="password" style="font-size: 20px;color: #000;">
            </div>
        </div>
        <div class="offset-s1 col s12">
            <table class="bordered centered" style="margin: 15px 0;">
                <tbody>
                <tr>
                    <td style="color: #000;font-weight: 700;">NAS 地址</td>
                    <td id="address"></td>
                    <td style="color: #000;font-weight: 700;">可用余额</td>
                    <td id="balance"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="offset-s1 col s12">
            <a class="waves-effect waves-light btn red" href="#modal1" style="margin-left: 130px;margin-bottom: 30px">扔出漂流瓶</a>
            <a class="waves-effect waves-light btn red" id="randomBottle" style="margin-left: 20px;margin-bottom: 30px">捞起漂流瓶</a>
        </div>


        <div id="paperWall">
            <!--<div style=";height: 250px;background: url(lib/img/paper.png) no-repeat;background-size: 100% 100%;margin:10px 30px;" class="col s3">
                <p style="text-align: center;">主题</p>
                <p style="text-align: center;">内容内容内容内容内容内容内容内容内容</p>
                <p style="text-align: right;">作者：啊啊啊</p>
                <p style="text-align: right;">时间：2018-05-11</p>
            </div>-->
        </div>
    </div>


    <!--<table class="bordered" style="width: 80%;margin:  0 auto">
        <thead>
        <tr>
            <th>主题</th>
            <th>内容</th>
            <th>作者</th>
            <th>时间</th>
        </tr>
        </thead>
        <tbody id="J_TbData">
        </tbody>
    </table>-->

</div>


<!-- Modal Structure -->
<div id="modal1" class="modal">
    <div class="modal-content">
        <div class="row">
            <form class="col s12">
                <div class="row">
                    <div class="input-field col s12">
                        <input placeholder="漂流瓶主题" id="bottle_title" type="text" class="validate">
                        <label>主题</label>
                    </div>
                    <div class="input-field col s12">
                        <input id="bottle_content" type="text" class="validate" placeholder="写一段想说的话">
                        <label>内容</label>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" style="color: white;background-color: dodgerblue"
           class="modal-action modal-close waves-effect waves-green btn-flat" id="newBottle">
            <i class="material-icons right">send</i>
            提交
        </a>
    </div>
</div>
</body>
<script src="lib/jquery-3.3.1.min.js"></script>

<script src="lib/bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>
<script src="lib/nebPay.js"></script>
<script src="lib/nebulas.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>

<script>
    "use strict";

    //
    //    $(".add").click(function () {
    //        neb.api.call({
    //            chainID: chainid,
    //            from: account.getAddressString(),
    //            to: contractAddress,
    //            value: amount * 1e18,
    //            nonce: 0,
    //            gasPrice: 1000000,
    //            gasLimit: 2000000,
    //            contract: {function: "newBottle", args: JSON.stringify([hash])}
    //        }).then(function (call) {
    //
    //        })
    $(document).ready(function () {
        $('.modal').modal();
        var contractAddress = "n1bUSoYrgTr7iBUR1LDS5svjLBd6wGdB4Ur";
        var HttpRequest = require("nebulas").HttpRequest;
        var Neb = require("nebulas").Neb;
        var Account = require("nebulas").Account;
        var account = null;
        var keyfile = null;
        var Transaction = require("nebulas").Transaction;
        var neb = new Neb();
        var balance = 0;
        var chainid = 1;
        neb.setRequest(new HttpRequest("https://mainnet.nebulas.io"));

        $('#privatekey').change(function () {
            if ($('#privatekey')[0].value.trim().length === 64) {
                Materialize.toast('正在查询地址信息', 3000);
                account = new Account($("#privatekey")[0].value.trim());
                $('#address').text(account.getAddressString());
                neb.api.getAccountState({address: account.getAddressString()}).then(function (state) {
                    balance = state.balance / 1e18
                    $('#balance').text(state.balance / 1e18 + ' NAS');
                    Materialize.toast('信息查询成功', 3000);

                });
            }

        });

        $('#keyfile').change(function (e) {
            var $this = $(this), file = e.target.files[0], fr = new FileReader();
            fr.onload = onload;
            fr.readAsText(file);

            function onload(e) {
                try {
                    keyfile = JSON.parse(e.target.result);
                    $('#keyfilepassworddiv').show();
                } catch (e) {
                    Materialize.toast(e, 3000);
                    return;
                }
            }
        });
        $('#keyfilepassword').change(function (e) {
            Materialize.toast('正在查询地址信息', 3000);
            account = new Account();
            try {
                account.fromKey(keyfile, $('#keyfilepassword')[0].value.trim());
            } catch (e) {
                Materialize.toast(e, 3000);
                return;
            }
            $('#address').text(account.getAddressString());
            neb.api.getAccountState({address: account.getAddressString()}).then(function (state) {
                balance = state.balance / 1e18
                $('#balance').text(state.balance / 1e18 + ' NAS');
                Materialize.toast('信息查询成功', 3000);
            });
        });
        //        if (balance < 0.0000) {
//            $("#choice_a_ticket").addClass("disabled")
//            $("#choice_b_ticket").addClass("disabled")
//
//        } else {
//            $("#choice_a_ticket").removeClass("disabled")
//            $("#choice_b_ticket").removeClass("disabled")
//        }

        $("#newBottle").click(function () {
            console.log(account);
            if (account === null || account.getPrivateKey() === undefined) {
                Materialize.toast('未登录钱包', 3000);
                return;
            }
            var title = $("#bottle_title").val();
            var content = $("#bottle_content").val();
            var author = account.getAddressString();
            neb.api.call({
                from: account.getAddressString(),
                to: contractAddress,
                value: 0.000001 * 1e18,
                nonce: 0,
                gasPrice: 1000000,
                gasLimit: 2000000,
                contract: {function: "newBottle", args: JSON.stringify([title, content])}
            }).then(function (call) {
                if (call.execute_err === '') {
                    neb.api.call({address: account.getAddressString()}).then(function (state) {
                        $('#balance').text(state.balance / 1e18 + ' NAS');
                        var tx = new Transaction({
                            chainID: chainid,
                            from: account,
                            to: contractAddress,
                            value: 0.000001 * 1e18,
                            nonce: parseInt(state.nonce) + 1,
                            gasPrice: 1000000,
                            gasLimit: 2000000,
                            contract: {function: "newBottle", args: JSON.stringify([title, content,author])}

                        });
                        tx.signTransaction();
                        neb.api.sendRawTransaction({data: tx.toProtoString()}).then(function (tx) {
                            Materialize.toast('TXid: ' + tx.txhash, 5000);
                        });
                    });
                } else {
                    Materialize.toast(call.execute_err, 3000);
                }
            })
        });

        $("#randomBottle").click(function () {
            console.log(account);
            if (account === null || account.getPrivateKey() === undefined) {
                Materialize.toast('未登录钱包', 3000);
                return;
            }
            neb.api.call({
                from: account.getAddressString(),
                to: contractAddress,
                value: 0,
                nonce: 0,
                gasPrice: 1000000,
                gasLimit: 2000000,
                contract: {function: "getRandomBottle", args: JSON.stringify([])}
            }).then(function (call) {
                if (call.execute_err === '') {
                    var html = "";
                    html += '<div style=";height: 250px;background: url(lib/img/paper.png) no-repeat;background-size: 100% 100%;margin:10px 30px;" class="col s3">';
                    html += '<p style="text-align: center;">' + result.title + '</p>';
                    html += '<p style="text-align: center;">'  + result.content + '</p>';
                    html += '<p style="text-align: right;">作者：' + result.author + '</p>';
                    html += '<p style="text-align: right;">时间：' + new Date(result.endTime * 1000).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ") + '</p>';
                    html += '</div>';
                    $("#paperWall").append(html);
                }
            })
        });

        //初始化
        function init() {

        };
        window.onload = init()
    })
    ;

</script>
</html>