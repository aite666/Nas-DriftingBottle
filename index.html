<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>星云漂流瓶</title>

    <style>

    </style>
</head>
<body>
<div class="row" style="background: url(lib/img/bg.png) no-repeat; background-size: 100% 100%;min-height:900px;">
    <div class="col offset-s2 s8">
        <div>
            <h4 style="text-align: center;">步骤说明</h4>
            <p style="font-size: 20px;">1.登录自己的钱包查看余额</p>
            <p style="font-size: 20px;">2.点击扔出漂流瓶可以扔出一个漂流瓶</p>
            <p style="font-size: 20px;">3.点击捞起漂流瓶可以随机捞起一个漂流瓶</p>
            <p style="font-size: 20px;">4.应用推广阶段,仅需支付 gas 即可参与</p>
        </div>

        <div class="noExtension" id="noExtension" style="display: none;">
            提示: 请安装
            <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 再使用星云漂流瓶
        </div>

        <div class="col s6">
            <p style="font-size: 20px;">导入钱包文件</p>
            <div class="file-field input-field ">
                <button class="btn waves-effect waves-light red">
                    <span>点击选择您的密钥文件</span>
                    <input type="file" id="keyfile">
                </button>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text">
                </div>
            </div>
        </div>
        <div class="offset-s1 col s5">
            <div id="keyfilepassworddiv" style="display: none;margin-top: 40px;">
                <label for="keyfilepassword" class="active" style="font-size: 20px;color: #000;">请输入您的密钥文件密码</label>
                <input placeholder="请输入您的密钥文件密码" class="center-align" id="keyfilepassword" type="password" style="font-size: 20px;color: #000;">
            </div>
        </div>
        <div class="offset-s1 col s12">
            <table class="bordered centered" style="margin: 15px 0;">
                <tbody>
                <tr>
                    <td style="color: #000;font-weight: 700;">NAS 地址</td>
                    <td id="address"></td>
                    <td style="color: #000;font-weight: 700;">可用余额</td>
                    <td id="balance"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="offset-s1 col s12">
            <a class="waves-effect waves-light btn red" href="#modal1" style="margin-left: 130px;margin-bottom: 30px">扔出漂流瓶</a>
            <a class="waves-effect waves-light btn red" id="randomBottle" style="margin-left: 20px;margin-bottom: 30px">捞起漂流瓶</a>
        </div>


        <div id="paperWall">
            <!--<div style="height: 250px;background: url(lib/img/paper.png) no-repeat;background-size: 100% 100%;margin:10px 30px;" class="col s3">
                <p style="text-align: right;font-size: 6px;word-wrap : break-word;position:relative;top:200px;margin: 0;">By:n1bUSoYrgTr7iBUR1LDS5svjLBd6wGdB4Ur</p>
                <p style="text-align: center;font-size: 20px;margin: 0 0 4px 0;">主题</p>
                <p style="text-align: center;margin: 0;">内容内容内容内容内容内容内容内容内容</p>
            </div>-->
        </div>
    </div>

</div>


<!-- Modal Structure -->
<div id="modal1" class="modal">
    <div class="modal-content">
        <div class="row">
            <form class="col s12">
                <div class="row">
                    <div class="input-field col s12">
                        <input placeholder="漂流瓶主题" id="bottle_title" type="text" class="validate">
                        <label>主题</label>
                    </div>
                    <div class="input-field col s12">
                        <input id="bottle_content" type="text" class="validate" placeholder="写一段想说的话">
                        <label>内容</label>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" style="color: white;background-color: dodgerblue"
           class="modal-action modal-close waves-effect waves-green btn-flat" id="newBottle">
            <i class="material-icons right">send</i>
            提交
        </a>
    </div>
</div>
</body>
<script src="lib/jquery-3.3.1.min.js"></script>

<script src="lib/bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>
<script src="js/nebPay.js"></script>
<script src="lib/nebPay.js"></script>
<script src="lib/nebulas.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>

<script>
    "use strict";
    $(document).ready(function () {

        //如果安装了扩展，var“webExtensionWallet”将被注入到web页面中1
        if(typeof(webExtensionWallet) === "undefined") {
            $("#noExtension").show();
        }else{
            $("#noExtension").hide();
        }

        $('.modal').modal();
        var contractAddress = "n1yrt52LhB7Pibuk3XEcb6Y48kQuXXjuc2N";
        var HttpRequest = require("nebulas").HttpRequest;
        var Neb = require("nebulas").Neb;
        var Account = require("nebulas").Account;
        var account = null;
        var keyfile = null;
        var Transaction = require("nebulas").Transaction;
        var neb = new Neb();
        var balance = 0;
        var chainid = 1;
        var NebPay = require("nebpay"); //https://github.com/nebulasio/nebPay
        var length = 0;
        var nebPay = new NebPay();
        neb.setRequest(new HttpRequest("https://mainnet.nebulas.io"));

        $('#privatekey').change(function () {
            if ($('#privatekey')[0].value.trim().length === 64) {
                Materialize.toast('正在查询地址信息', 3000);
                account = new Account($("#privatekey")[0].value.trim());
                $('#address').text(account.getAddressString());
                neb.api.getAccountState({address: account.getAddressString()}).then(function (state) {
                    balance = state.balance / 1e18
                    $('#balance').text(state.balance / 1e18 + ' NAS');
                    Materialize.toast('信息查询成功', 3000);

                });
            }
        });

        $('#keyfile').change(function (e) {
            var $this = $(this), file = e.target.files[0], fr = new FileReader();
            fr.onload = onload;
            fr.readAsText(file);

            function onload(e) {
                try {
                    keyfile = JSON.parse(e.target.result);
                    $('#keyfilepassworddiv').show();
                } catch (e) {
                    Materialize.toast(e, 3000);
                    return;
                }
            }
        });
        $('#keyfilepassword').change(function (e) {
            Materialize.toast('正在查询地址信息', 3000);
            account = new Account();
            try {
                account.fromKey(keyfile, $('#keyfilepassword')[0].value.trim());
            } catch (e) {
                Materialize.toast(e, 3000);
                return;
            }
            $('#address').text(account.getAddressString());
            neb.api.getAccountState({address: account.getAddressString()}).then(function (state) {
                balance = state.balance / 1e18
                $('#balance').text(state.balance / 1e18 + ' NAS');
                Materialize.toast('信息查询成功', 3000);
            });
        });

        $("#newBottle").click(function () {
            console.log(account);
            if (account === null || account.getPrivateKey() === undefined) {
                Materialize.toast('未登录钱包', 3000);
                return;
            }
            var title = $("#bottle_title").val();
            var content = $("#bottle_content").val();
            var author = account.getAddressString();
            var callArgs = [];
            callArgs.push(title);
            callArgs.push(content);
            callArgs.push(author);
            nebPay.call(contractAddress, "0" ,"newBottle",JSON.stringify(callArgs) ,{
                listener : cbPush1
            });
        });

        $("#randomBottle").click(function () {
            console.log(account);
            if (account === null || account.getPrivateKey() === undefined) {
                Materialize.toast('未登录钱包', 3000);
                return;
            }
            nebPay.simulateCall(contractAddress, "0" ,"getLen",JSON.stringify([]) ,{
                listener : cbPush2
            });
            var callArgs = [];
            var random = parseInt(Math.random()*length);
            callArgs.push(random);
            nebPay.simulateCall(contractAddress, "0" ,"getOneBottle",JSON.stringify(callArgs) ,{
                listener : cbPush3
            });
        });

        function cbPush1(resp) {
            console.log(resp);
        }

        function cbPush2(resp) {
            length = resp.result;
        }

        function cbPush3(resp) {
            console.log(resp);
            var result = JSON.parse(resp.result);
            var html = "";
            html += '<div style=";height: 250px;background: url(lib/img/paper.png) no-repeat;background-size: 100% 100%;margin:10px 30px;" class="col s3">';
            html += '<p style="text-align: right;font-size: 6px;word-wrap : break-word;position:relative;top:200px;margin: 0;">By:' + result.author + '</p>';
            html += '<p style="text-align: center;font-size: 20px;margin: 0 0 4px 0;">' + result.title + '</p>';
            html += '<p style="text-align: center;margin: 0;">'  + result.content + '</p>';
            html += '</div>';
            $("#paperWall").append(html);
        }

        //初始化
        function init() {

        };
        window.onload = init()
    })
    ;

</script>
</html>